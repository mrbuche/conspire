name: Docker
on:
  push:
    branches: main
  pull_request:
    branches: main
  release:
    types: published
jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Release
        if: github.event_name == 'release'
        id: last_release
        uses: InsonusK/get-latest-release@v1.1.0
        with:
          myToken: ${{ github.token }}
          view_top: 1
      - name: Login
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PAT }}
      - name: Build
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          push: false
          tags: mrbuche/conspire:latest
      - name: Build and push
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: mrbuche/conspire:latest
      - name: Build and push
        if: github.event_name == 'release'
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: mrbuche/conspire:${{ steps.last_release.outputs.tag_name }}
